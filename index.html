<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mini Discord Clone</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onChildAdded, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCBR4luboeizdAY2IUPAxztBY5OxzqvOPE",
      authDomain: "mini-discord-92075.firebaseapp.com",
      databaseURL: "https://mini-discord-92075-default-rtdb.firebaseio.com",
      projectId: "mini-discord-92075",
      storageBucket: "mini-discord-92075.appspot.com",
      messagingSenderId: "293790109506",
      appId: "1:293790109506:web:9ed85bc407ad529df2c2db",
      measurementId: "G-J3FSRT61NM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const loginForm = document.getElementById("loginForm");
    const chatUI = document.getElementById("chatUI");
    const messages = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const logoutBtn = document.getElementById("logoutBtn");
    const serverSelect = document.getElementById("serverSelect");
    const newServerInput = document.getElementById("newServer");
    const createServerBtn = document.getElementById("createServerBtn");
    const dmEmailInput = document.getElementById("dmEmail");
    const dmTextInput = document.getElementById("dmText");
    const sendDmBtn = document.getElementById("sendDmBtn");
    const dmBox = document.getElementById("dmBox");

    let currentServer = "general";

    const loadServers = async () => {
      const serversSnap = await get(child(ref(db), "servers"));
      serverSelect.innerHTML = "";
      if (serversSnap.exists()) {
        Object.keys(serversSnap.val()).forEach(server => {
          const opt = document.createElement("option");
          opt.value = server;
          opt.textContent = server;
          serverSelect.appendChild(opt);
        });
      }
    };

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const pass = loginForm.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch {
        await createUserWithEmailAndPassword(auth, email, pass);
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        loginForm.style.display = "none";
        chatUI.style.display = "block";
        loadServers();
        loadMessages();
        listenForDMs();
      } else {
        loginForm.style.display = "block";
        chatUI.style.display = "none";
      }
    });

    const loadMessages = () => {
      messages.innerHTML = "";
      onChildAdded(ref(db, `servers/${currentServer}`), data => {
        const msg = data.val();
        const div = document.createElement("div");
        div.textContent = `${msg.user}: ${msg.text}`;
        messages.appendChild(div);
      });
    };

    sendButton.onclick = () => {
      const msgRef = push(ref(db, `servers/${currentServer}`));
      set(msgRef, {
        user: auth.currentUser.email,
        text: messageInput.value,
        timestamp: Date.now()
      });
      messageInput.value = "";
    };

    logoutBtn.onclick = () => signOut(auth);

    createServerBtn.onclick = () => {
      const serverName = newServerInput.value.trim();
      if (!serverName) return;
      set(ref(db, `servers/${serverName}`), { welcome: { user: "system", text: `Welcome to ${serverName}` } });
      newServerInput.value = "";
      loadServers();
    };

    serverSelect.onchange = () => {
      currentServer = serverSelect.value;
      loadMessages();
    };

    sendDmBtn.onclick = () => {
      const to = dmEmailInput.value;
      const text = dmTextInput.value;
      if (!to || !text) return;
      const from = auth.currentUser.email;
      const chatKey = [from, to].sort().join("--");
      const dmRef = push(ref(db, `dms/${chatKey}`));
      set(dmRef, { from, to, text, timestamp: Date.now() });
      dmTextInput.value = "";
    };

    const listenForDMs = () => {
      const userEmail = auth.currentUser.email;
      onChildAdded(ref(db, "dms"), snap => {
        const chatKey = snap.key;
        if (!chatKey.includes(userEmail)) return;
        onChildAdded(ref(db, `dms/${chatKey}`), msgSnap => {
          const msg = msgSnap.val();
          const div = document.createElement("div");
          div.textContent = `DM from ${msg.from} to ${msg.to}: ${msg.text}`;
          dmBox.appendChild(div);
        });
      });
    };
  </script>
  <style>
    body { font-family: sans-serif; display: flex; gap: 20px; }
    #chatUI { display: none; }
    #messages, #dmBox { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
  </style>
</head>
<body>
  <form id="loginForm">
    <h3>Login / Register</h3>
    <input name="email" type="email" placeholder="Email"><br>
    <input name="password" type="password" placeholder="Password"><br>
    <button type="submit">Login / Register</button>
  </form>

  <div id="chatUI">
    <h3>Servers</h3>
    <select id="serverSelect"></select><br>
    <input id="newServer" placeholder="New server name">
    <button id="createServerBtn">Create Server</button>

    <h3>Chat</h3>
    <div id="messages"></div>
    <input id="messageInput" placeholder="Message">
    <button id="sendButton">Send</button>

    <h3>Direct Messages</h3>
    <input id="dmEmail" placeholder="To email">
    <input id="dmText" placeholder="Message">
    <button id="sendDmBtn">Send DM</button>
    <div id="dmBox"></div>

    <br>
    <button id="logoutBtn">Logout</button>
  </div>
</body>
</html>
