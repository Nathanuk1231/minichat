<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Discord Clone</title>
<style>
  /* Discord-like colors and layout */
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: "Whitney", "Helvetica Neue", Helvetica, Arial, sans-serif;
    background-color: #36393f;
    color: #dcddde;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  #sidebar {
    width: 260px;
    background: #2f3136;
    display: flex;
    flex-direction: column;
    padding: 10px;
  }
  #sidebar h2 {
    margin: 10px 0 8px 10px;
    font-weight: 700;
    font-size: 18px;
    color: #b9bbbe;
  }
  #serversList, #usersList {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 20px;
  }
  .server, .user {
    padding: 8px 10px;
    border-radius: 5px;
    cursor: pointer;
    margin: 4px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .server:hover, .user:hover {
    background: #40444b;
  }
  .server.selected, .user.selected {
    background: #5865f2;
    color: white;
  }
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #36393f;
  }
  #header {
    padding: 15px 20px;
    border-bottom: 1px solid #2f3136;
    font-weight: 600;
    font-size: 20px;
    color: #fff;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px 20px;
  }
  .message {
    margin-bottom: 12px;
  }
  .message .sender {
    font-weight: 700;
    color: #7289da;
  }
  .message .text {
    margin-left: 8px;
    color: #dcddde;
  }
  #inputArea {
    display: flex;
    padding: 10px 20px;
    border-top: 1px solid #2f3136;
  }
  #messageInput {
    flex: 1;
    padding: 10px;
    border-radius: 4px;
    border: none;
    font-size: 14px;
    background-color: #40444b;
    color: #dcddde;
  }
  #messageInput:focus {
    outline: none;
  }
  #sendBtn {
    margin-left: 10px;
    padding: 10px 16px;
    background-color: #5865f2;
    border: none;
    border-radius: 4px;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }
  #sendBtn:disabled {
    background-color: #40444b;
    cursor: not-allowed;
  }
  button.deleteBtn {
    background-color: #f04747;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 12px;
  }
  #createServerForm, #loginForm {
    margin: 10px 0;
  }
  #createServerInput, #emailInput, #passwordInput {
    padding: 8px;
    width: calc(100% - 20px);
    margin-bottom: 8px;
    border-radius: 4px;
    border: none;
  }
  #createServerBtn, #loginBtn, #logoutBtn {
    background-color: #5865f2;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }
  #logoutBtn {
    margin-top: 10px;
    width: 100%;
  }
  #loginForm {
    padding: 20px;
    background: #2f3136;
    border-radius: 8px;
  }
  #errorMsg {
    color: #f04747;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Servers</h2>
  <div id="serversList"></div>
  <form id="createServerForm">
    <input type="text" id="createServerInput" placeholder="New server name" required />
    <button type="submit" id="createServerBtn">Create Server</button>
  </form>

  <h2>Users</h2>
  <div id="usersList"></div>
  <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="main">
  <div id="header">Please log in to start chatting</div>
  <div id="messages"></div>
  <div id="inputArea" style="display:none;">
    <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
    <button id="sendBtn" disabled>Send</button>
  </div>

  <div id="loginForm">
    <div id="errorMsg"></div>
    <input type="email" id="emailInput" placeholder="Email" required />
    <input type="password" id="passwordInput" placeholder="Password" required />
    <button id="loginBtn">Login / Register</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDgddDLpa2XSLvzNBzSd1dkkkZ5Kt32axM",
    authDomain: "coolwebsitechat.firebaseapp.com",
    databaseURL: "https://coolwebsitechat-default-rtdb.firebaseio.com",
    projectId: "coolwebsitechat",
    storageBucket: "coolwebsitechat.firebasestorage.app",
    messagingSenderId: "341962893234",
    appId: "1:341962893234:web:c3b1ca2a1279bce71326ab"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // DOM Elements
  const serversList = document.getElementById("serversList");
  const usersList = document.getElementById("usersList");
  const messagesDiv = document.getElementById("messages");
  const header = document.getElementById("header");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const createServerForm = document.getElementById("createServerForm");
  const createServerInput = document.getElementById("createServerInput");
  const loginForm = document.getElementById("loginForm");
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const errorMsg = document.getElementById("errorMsg");
  const inputArea = document.getElementById("inputArea");

  let currentUser = null;
  let currentServerId = null;
  let currentDMUserId = null;
  let servers = {};
  let users = {};

  // Basic profanity list - customize this
  const bannedWords = [
    "badword1", "badword2", "somecurse", "racistword1", "racistword2"
  ];
  function containsBannedWords(text) {
    const lowered = text.toLowerCase();
    return bannedWords.some(word => lowered.includes(word));
  }

  // Listen for auth state changes
  onAuthStateChanged(auth, user => {
    currentUser = user;
    if(user) {
      loginForm.style.display = "none";
      logoutBtn.style.display = "block";
      inputArea.style.display = "flex";
      loadUsers();
      loadServers();
      header.textContent = "Select a server or user to start chatting";
    } else {
      loginForm.style.display = "block";
      logoutBtn.style.display = "none";
      inputArea.style.display = "none";
      serversList.innerHTML = "";
      usersList.innerHTML = "";
      messagesDiv.innerHTML = "";
      header.textContent = "Please log in to start chatting";
      currentServerId = null;
      currentDMUserId = null;
    }
  });

  // Login or Register user
  loginBtn.onclick = async (e) => {
    e.preventDefault();
    errorMsg.textContent = "";
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if(!email || !password) return;

    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      if(error.code === "auth/user-not-found") {
        try {
          await createUserWithEmailAndPassword(auth, email, password);
        } catch (e) {
          errorMsg.textContent = e.message;
          return;
        }
      } else {
        errorMsg.textContent = error.message;
        return;
      }
    }
  };

  logoutBtn.onclick = async () => {
    await signOut(auth);
  };

  // Load all users (except current user)
  function loadUsers() {
    const usersRef = ref(db, "users");
    onValue(usersRef, snapshot => {
      usersList.innerHTML = "";
      users = snapshot.val() || {};
      // Make sure current user is added
      if(currentUser && !users[currentUser.uid]) {
        set(ref(db, `users/${currentUser.uid}`), { email: currentUser.email });
      }
      Object.entries(users).forEach(([uid, user]) => {
        if(uid === currentUser.uid) return;
        const div = document.createElement("div");
        div.className = "user";
        div.textContent = user.email;
        div.onclick = () => {
          selectDM(uid, user.email);
        };
        if(currentDMUserId === uid) div.classList.add("selected");
        usersList.appendChild(div);
      });
    });
  }

  // Load servers
  function loadServers() {
    const serversRef = ref(db, "servers");
    onValue(serversRef, snapshot => {
      serversList.innerHTML = "";
      servers = snapshot.val() || {};
      Object.entries(servers).forEach(([serverId, server]) => {
        const div = document.createElement("div");
        div.className = "server";
        div.textContent = server.name;
        if(currentServerId === serverId) div.classList.add("selected");

        // Delete button if owner
        if(server.ownerUid === currentUser.uid) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "deleteBtn";
          delBtn.onclick = async (e) => {
            e.stopPropagation();
            if(confirm(`Delete server "${server.name}"? This cannot be undone.`)) {
              await remove(ref(db, `servers/${serverId}`));
              await remove(ref(db, `messages/${serverId}`));
              if(currentServerId === serverId) {
                currentServerId = null;
                messagesDiv.innerHTML = "";
                header.textContent = "Select a server or user to start chatting";
              }
            }
          };
          div.appendChild(delBtn);
        }

        div.onclick = () => {
          currentServerId = serverId;
          currentDMUserId = null;
          highlightSelected();
          listenToServerMessages(serverId);
          header.textContent = `# ${server.name}`;
        };
        serversList.appendChild(div);
      });
    });
  }

  // Highlight selected server or DM
  function highlightSelected() {
    // Servers
    serversList.childNodes.forEach(div => {
      if(div.classList.contains("server")) {
        div.classList.toggle("selected", div.textContent === (servers[currentServerId]?.name));
      }
    });
    // Users
    usersList.childNodes.forEach(div => {
      if(div.classList.contains("user")) {
        div.classList.toggle("selected", users[ currentDMUserId ]?.email === div.textContent);
      }
    });
  }

  // Listen to messages in a server
  let serverMessagesListener = null;
  function listenToServerMessages(serverId) {
    if(serverMessagesListener) serverMessagesListener();
    messagesDiv.innerHTML = "";
    const messagesRef = ref(db, `messages/${serverId}`);
    serverMessagesListener = onValue(messagesRef, snapshot => {
      messagesDiv.innerHTML = "";
      const messages = snapshot.val() || {};
      Object.values(messages).forEach(msg => {
        const div = document.createElement("div");
        div.className = "message";
        const senderSpan = document.createElement("span");
        senderSpan.className = "sender";
        senderSpan.textContent = msg.senderEmail || "Unknown";
        const textSpan = document.createElement("span");
        textSpan.className = "text";
        textSpan.textContent = ": " + msg.text;
        div.appendChild(senderSpan);
        div.appendChild(textSpan);
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // DMs
  let dmMessagesListener = null;
  function selectDM(uid, email) {
    currentDMUserId = uid;
    currentServerId = null;
    highlightSelected();
    header.textContent = `DM: ${email}`;
    if(dmMessagesListener) dmMessagesListener();
    messagesDiv.innerHTML = "";
    const pairKey = [currentUser.uid, uid].sort().join("_");
    const dmRef = ref(db, `dms/${pairKey}`);
    dmMessagesListener = onValue(dmRef, snapshot => {
      messagesDiv.innerHTML = "";
      const messages = snapshot.val() || {};
      Object.values(messages).forEach(msg => {
        const div = document.createElement("div");
        div.className = "message";
        const senderSpan = document.createElement("span");
        senderSpan.className = "sender";
        senderSpan.textContent = msg.senderEmail || "Unknown";
        const textSpan = document.createElement("span");
        textSpan.className = "text";
        textSpan.textContent = ": " + msg.text;
        div.appendChild(senderSpan);
        div.appendChild(textSpan);
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // Create new server
  createServerForm.onsubmit = async (e) => {
    e.preventDefault();
    const name = createServerInput.value.trim();
    if(!name) return;
    const newServerRef = push(ref(db, "servers"));
    await set(newServerRef, {
      name,
      ownerUid: currentUser.uid
    });
    createServerInput.value = "";
  };

  // Send message button state
  messageInput.addEventListener("input", () => {
    sendBtn.disabled = !messageInput.value.trim();
  });

  // Send message
  sendBtn.onclick = async () => {
    const text = messageInput.value.trim();
    if (!text) return;

    if (containsBannedWords(text)) {
      alert("Your message contains inappropriate language and was blocked.");
      return;
    }

    messageInput.value = "";
    sendBtn.disabled = true;

    if (currentServerId) {
      const messagesRef = ref(db, `messages/${currentServerId}`);
      await push(messagesRef, {
        senderUid: currentUser.uid,
        senderEmail: currentUser.email,
        text,
        timestamp: Date.now()
      });
    } else if (currentDMUserId) {
      const pairKey = [currentUser.uid, currentDMUserId].sort().join("_");
      const dmRef = ref(db, `dms/${pairKey}`);
      await push(dmRef, {
        senderUid: currentUser.uid,
        senderEmail: currentUser.email,
        text,
        timestamp: Date.now()
      });
    } else {
      alert("Select a server or user to send messages.");
    }
  };
</script>
</body>
</html>
