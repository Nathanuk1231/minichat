<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mini Discord Clone</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onChildAdded, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCBR4luboeizdAY2IUPAxztBY5OxzqvOPE",
      authDomain: "mini-discord-92075.firebaseapp.com",
      databaseURL: "https://mini-discord-92075-default-rtdb.firebaseio.com",
      projectId: "mini-discord-92075",
      storageBucket: "mini-discord-92075.appspot.com",
      messagingSenderId: "293790109506",
      appId: "1:293790109506:web:9ed85bc407ad529df2c2db",
      measurementId: "G-J3FSRT61NM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentServer = "general";

    const loginForm = document.getElementById("loginForm");
    const chatUI = document.getElementById("chatUI");
    const serverSelect = document.getElementById("serverSelect");
    const newServerInput = document.getElementById("newServer");
    const messages = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const logoutBtn = document.getElementById("logoutBtn");
    const createServerBtn = document.getElementById("createServerBtn");
    const dmEmailInput = document.getElementById("dmEmail");
    const dmTextInput = document.getElementById("dmText");
    const sendDmBtn = document.getElementById("sendDmBtn");
    const dmBox = document.getElementById("dmBox");

    const loadServers = async () => {
      const serversSnap = await get(child(ref(db), "servers"));
      serverSelect.innerHTML = "";
      if (serversSnap.exists()) {
        Object.keys(serversSnap.val()).forEach(server => {
          const opt = document.createElement("option");
          opt.value = server;
          opt.textContent = server;
          serverSelect.appendChild(opt);
        });
      }
    };

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const pass = loginForm.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        await createUserWithEmailAndPassword(auth, email, pass);
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        loginForm.style.display = "none";
        chatUI.style.display = "flex";
        loadServers();
        loadMessages();
        listenForDMs();
      } else {
        loginForm.style.display = "flex";
        chatUI.style.display = "none";
      }
    });

    const loadMessages = () => {
      messages.innerHTML = "";
      onChildAdded(ref(db, `servers/${currentServer}`), data => {
        const msg = data.val();
        const div = document.createElement("div");
        div.className = "message";
        div.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
        messages.appendChild(div);
      });
    };

    sendButton.onclick = () => {
      const msgRef = push(ref(db, `servers/${currentServer}`));
      set(msgRef, {
        user: auth.currentUser.email,
        text: messageInput.value,
        timestamp: Date.now()
      });
      messageInput.value = "";
    };

    createServerBtn.onclick = () => {
      const name = newServerInput.value.trim();
      if (!name) return;
      set(ref(db, `servers/${name}`), {
        welcome: { user: "system", text: `Welcome to ${name}` }
      });
      newServerInput.value = "";
      loadServers();
    };

    serverSelect.onchange = () => {
      currentServer = serverSelect.value;
      loadMessages();
    };

    sendDmBtn.onclick = () => {
      const to = dmEmailInput.value;
      const text = dmTextInput.value;
      if (!to || !text) return;
      const from = auth.currentUser.email;
      const key = [from, to].sort().join("--");
      const refDm = push(ref(db, `dms/${key}`));
      set(refDm, { from, to, text, timestamp: Date.now() });
      dmTextInput.value = "";
    };

    const listenForDMs = () => {
      const email = auth.currentUser.email;
      onChildAdded(ref(db, "dms"), snap => {
        const key = snap.key;
        if (!key.includes(email)) return;
        onChildAdded(ref(db, `dms/${key}`), msgSnap => {
          const msg = msgSnap.val();
          const div = document.createElement("div");
          div.className = "dm-message";
          div.textContent = `DM from ${msg.from}: ${msg.text}`;
          dmBox.appendChild(div);
        });
      });
    };

    logoutBtn.onclick = () => signOut(auth);
  </script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #2c2f33;
      color: #fff;
      display: flex;
      height: 100vh;
    }
    #loginForm, #chatUI {
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #23272a;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000a;
    }
    input, button, select {
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }
    input, select {
      background: #2c2f33;
      color: white;
      border: 1px solid #7289da;
    }
    button {
      background: #7289da;
      color: white;
      cursor: pointer;
    }
    #messages, #dmBox {
      background: #2c2f33;
      border: 1px solid #7289da;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
    }
    .message, .dm-message {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <form id="loginForm">
    <h2>Login / Register</h2>
    <input name="email" type="email" placeholder="Email">
    <input name="password" type="password" placeholder="Password">
    <button type="submit">Login</button>
  </form>

  <div id="chatUI">
    <h2>Mini Discord</h2>
    <select id="serverSelect"></select>
    <input id="newServer" placeholder="New Server Name">
    <button id="createServerBtn">Create Server</button>

    <h3>Channel Messages</h3>
    <div id="messages"></div>
    <input id="messageInput" placeholder="Type your message">
    <button id="sendButton">Send</button>

    <h3>Direct Messages</h3>
    <input id="dmEmail" placeholder="Recipient Email">
    <input id="dmText" placeholder="Type a DM">
    <button id="sendDmBtn">Send DM</button>
    <div id="dmBox"></div>

    <button id="logoutBtn">Logout</button>
  </div>
</body>
</html>

