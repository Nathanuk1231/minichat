<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Discord Clone</title>
<style>
  :root {
    --color-bg-light: #f9f9f9;
    --color-text-light: #222;
    --color-bg-dark: #23272a;
    --color-text-dark: #fff;
    --color-bg-rainbow: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
  }

  body.light {
    background-color: var(--color-bg-light);
    color: var(--color-text-light);
  }
  body.dark {
    background-color: var(--color-bg-dark);
    color: var(--color-text-dark);
  }
  body.rainbow {
    background: var(--color-bg-rainbow);
    color: #fff;
  }

  * {
    box-sizing: border-box;
  }

  body, html {
    margin: 0; padding: 0; height: 100vh;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  #app {
    display: flex; flex-direction: column; height: 100vh;
  }

  header {
    background: #2f3136;
    padding: 10px;
    display: flex; align-items: center; justify-content: space-between;
    color: white;
  }

  #themeSwitcher button {
    margin-left: 8px;
    background: none;
    border: 1px solid #555;
    color: #ddd;
    cursor: pointer;
    padding: 5px 8px;
    border-radius: 3px;
  }
  #themeSwitcher button:hover {
    background: #555;
  }

  #loginPanel {
    margin: auto; max-width: 400px; padding: 20px;
    background: #2f3136; border-radius: 8px;
    color: white;
  }
  #loginPanel input {
    width: 100%; margin: 10px 0; padding: 8px;
    border-radius: 5px; border: none;
    font-size: 16px;
  }
  #loginPanel button {
    width: 100%; padding: 10px;
    background: #7289da; border: none; border-radius: 5px;
    font-weight: bold; font-size: 16px;
    cursor: pointer;
  }
  #loginPanel button:hover {
    background: #5b6eae;
  }
  #errorMsg {
    color: #f04747;
    margin-top: 10px;
  }

  #mainUI {
    display: flex; flex: 1; height: 100%;
    background: #2f3136;
    color: white;
  }

  #sidebar {
    width: 280px; background: #202225; padding: 10px;
    display: flex; flex-direction: column;
  }
  #sidebar h2 {
    margin: 0 0 10px 0; font-weight: 600;
  }
  #serverList, #dmList {
    flex: 1; overflow-y: auto; margin-bottom: 10px;
  }
  #serverList button, #dmList button {
    width: 100%; margin-bottom: 5px;
    background: #36393f; border: none;
    padding: 10px;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    text-align: left;
  }
  #serverList button.selected, #dmList button.selected {
    background: #5865f2;
  }
  #newServerBtn, #logoutBtn {
    margin-top: 10px;
    background: #5865f2;
    border: none;
    color: white;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
  }
  #newServerBtn:hover, #logoutBtn:hover {
    background: #4752c4;
  }

  #chatArea {
    flex: 1; display: flex; flex-direction: column; background: #36393f;
  }
  #chatHeader {
    padding: 10px;
    border-bottom: 1px solid #202225;
    font-weight: 600;
    font-size: 18px;
  }
  #messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
  }
  .message {
    padding: 6px 10px;
    margin-bottom: 6px;
    border-radius: 5px;
    background: #2f3136;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .message.self {
    background: #5865f2;
  }
  .message .text {
    flex: 1;
    margin-left: 6px;
    word-break: break-word;
  }
  .message .username {
    font-weight: bold;
  }
  .message button.deleteBtn {
    background: none;
    border: none;
    color: #f04747;
    cursor: pointer;
    font-weight: bold;
    margin-left: 8px;
    font-size: 16px;
  }
  #inputArea {
    display: flex;
    border-top: 1px solid #202225;
  }
  #inputMessage {
    flex: 1;
    border: none;
    padding: 15px;
    font-size: 16px;
    background: #40444b;
    color: white;
    outline: none;
  }
  #sendBtn {
    background: #5865f2;
    border: none;
    color: white;
    padding: 0 20px;
    cursor: pointer;
  }
  #sendBtn:hover {
    background: #4752c4;
  }

  /* Scrollbar */
  #messages::-webkit-scrollbar {
    width: 8px;
  }
  #messages::-webkit-scrollbar-thumb {
    background: #5865f2;
    border-radius: 4px;
  }
</style>
</head>
<body class="dark">
<div id="app">

<header>
  <div>Mini Discord Clone</div>
  <div id="themeSwitcher">
    Theme: 
    <button data-theme="light">Light</button>
    <button data-theme="dark">Dark</button>
    <button data-theme="rainbow">Rainbow</button>
  </div>
</header>

<!-- LOGIN PANEL -->
<div id="loginPanel">
  <h2>Login or Register</h2>
  <input id="email" type="email" placeholder="Email" required />
  <input id="password" type="password" placeholder="Password" required />
  <button id="loginBtn">Login / Register</button>
  <div id="errorMsg"></div>
</div>

<!-- MAIN UI -->
<div id="mainUI" style="display:none;">
  <div id="sidebar">
    <h2>Servers</h2>
    <div id="serverList"></div>
    <button id="newServerBtn">+ New Server</button>

    <h2>Direct Messages</h2>
    <div id="dmList"></div>

    <button id="logoutBtn">Logout</button>
  </div>

  <div id="chatArea">
    <div id="chatHeader">Select a server or DM</div>
    <div id="messages"></div>
    <div id="inputArea" style="display:none;">
      <input id="inputMessage" placeholder="Type a message..." autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>
</div>

<script type="module">
// Firebase SDK imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDgddDLpa2XSLvzNBzSd1dkkkZ5Kt32axM",
  authDomain: "coolwebsitechat.firebaseapp.com",
  databaseURL: "https://coolwebsitechat-default-rtdb.firebaseio.com",
  projectId: "coolwebsitechat",
  storageBucket: "coolwebsitechat.firebasestorage.app",
  messagingSenderId: "341962893234",
  appId: "1:341962893234:web:c3b9db4848222ef0ef68bb"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Admin UID you gave me
const ADMIN_UID = "kugkByA4h5U7CIag7gEG8M8L7um1";

// Elements
const loginPanel = document.getElementById("loginPanel");
const mainUI = document.getElementById("mainUI");
const errorMsg = document.getElementById("errorMsg");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

const serverListEl = document.getElementById("serverList");
const dmListEl = document.getElementById("dmList");
const newServerBtn = document.getElementById("newServerBtn");

const chatHeader = document.getElementById("chatHeader");
const messagesEl = document.getElementById("messages");
const inputArea = document.getElementById("inputArea");
const inputMessage = document.getElementById("inputMessage");
const sendBtn = document.getElementById("sendBtn");

const themeButtons = document.querySelectorAll("#themeSwitcher button");

let currentUser = null;
let currentChannel = null; // { type: "server"|"dm", id, name }
let servers = {};
let dms = {};
let messagesListeners = [];
let profanityWords = ["fuck", "shit", "asshole", "bitch", "cunt", "nigger", "motherfucker", "faggot"];
// Profanity filter - simple word replacement with stars
function filterProfanity(text) {
  let filtered = text;
  profanityWords.forEach(word => {
    const re = new RegExp(`\\b${word}\\b`, "gi");
    filtered = filtered.replace(re, "*".repeat(word.length));
  });
  return filtered;
}

// THEME HANDLING
function applyTheme(theme) {
  document.body.classList.remove("light", "dark", "rainbow");
  document.body.classList.add(theme);
}
themeButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    applyTheme(btn.dataset.theme);
  });
});

// AUTH
loginBtn.onclick = async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();
  if (!email || !password) {
    errorMsg.textContent = "Please enter email and password.";
    return;
  }
  errorMsg.textContent = "";
  try {
    // Try sign in first
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    currentUser = userCredential.user;
    onUserLoggedIn();
  } catch (err) {
    if (err.code === "auth/user-not-found") {
      // Register new user
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        onUserLoggedIn();
      } catch (regErr) {
        errorMsg.textContent = regErr.message;
      }
    } else {
      errorMsg.textContent = err.message;
    }
  }
};

logoutBtn.onclick = () => {
  signOut(auth);
};

// WHEN USER LOGS IN
function onUserLoggedIn() {
  loginPanel.style.display = "none";
  mainUI.style.display = "flex";
  loadServersAndDMs();
  setupRealtimeListeners();
  setupUI();
}

// LOAD SERVERS AND DMs
function loadServersAndDMs() {
  // Servers
  const serversRef = ref(db, "servers");
  onValue(serversRef, (snapshot) => {
    servers = snapshot.val() || {};
    renderServers();
  });

  // DMs: We define DM channels under "dms" node. A DM channel's id is a sorted concatenation of user UIDs.
  const dmsRef = ref(db, "dms");
  onValue(dmsRef, (snapshot) => {
    dms = snapshot.val() || {};
    renderDMs();
  });
}

// RENDER SERVERS
function renderServers() {
  serverListEl.innerHTML = "";
  Object.entries(servers).forEach(([id, srv]) => {
    const btn = document.createElement("button");
    btn.textContent = srv.name || "Unnamed Server";
    btn.classList.toggle("selected", currentChannel?.type === "server" && currentChannel.id === id);
    btn.onclick = () => {
      selectChannel("server", id, srv.name);
    };
    serverListEl.appendChild(btn);
  });
}

// RENDER DMs
function renderDMs() {
  dmListEl.innerHTML = "";
  Object.entries(dms).forEach(([id, dm]) => {
    // DM id = uid1_uid2 sorted
    const otherUid = id.split("_").find(uid => uid !== currentUser.uid);
    const otherName = dm.name || otherUid;
    const btn = document.createElement("button");
    btn.textContent = otherName;
    btn.classList.toggle("selected", currentChannel?.type === "dm" && currentChannel.id === id);
    btn.onclick = () => {
      selectChannel("dm", id, otherName);
    };
    dmListEl.appendChild(btn);
  });
}

// SELECT CHANNEL
function selectChannel(type, id, name) {
  currentChannel = { type, id, name };
  chatHeader.textContent = (type === "server" ? "Server: " : "DM: ") + name;
  renderServers();
  renderDMs();
  loadMessages();
}

// LOAD MESSAGES
function loadMessages() {
  // Remove old listeners
  messagesListeners.forEach(unsub => unsub());
  messagesListeners = [];
  messagesEl.innerHTML = "";

  if (!currentChannel) return;

  const path = currentChannel.type === "server" ? `messages/servers/${currentChannel.id}` : `messages/dms/${currentChannel.id}`;
  const messagesRef = ref(db, path);

  const listener = onValue(messagesRef, (snapshot) => {
    messagesEl.innerHTML = "";
    const msgs = snapshot.val() || {};
    Object.entries(msgs).forEach(([msgId, msg]) => {
      const msgEl = createMessageElement(msgId, msg);
      messagesEl.appendChild(msgEl);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

  messagesListeners.push(() => messagesRef.off(listener));
}

// CREATE MESSAGE ELEMENT
function createMessageElement(msgId, msg) {
  const div = document.createElement("div");
  div.classList.add("message");
  if (msg.userId === currentUser.uid) div.classList.add("self");

  const userSpan = document.createElement("span");
  userSpan.classList.add("username");
  userSpan.textContent = msg.username || "Unknown";

  const textSpan = document.createElement("span");
  textSpan.classList.add("text");
  textSpan.textContent = filterProfanity(msg.text);

  div.appendChild(userSpan);
  div.appendChild(textSpan);

  // Show delete button if this user is admin OR the message owner
  if (msg.userId === currentUser.uid || currentUser.uid === ADMIN_UID) {
    const delBtn = document.createElement("button");
    delBtn.textContent = "×";
    delBtn.title = "Delete message";
    delBtn.classList.add("deleteBtn");
    delBtn.onclick = () => {
      if (confirm("Delete this message?")) {
        const path = currentChannel.type === "server" ? `messages/servers/${currentChannel.id}/${msgId}` : `messages/dms/${currentChannel.id}/${msgId}`;
        remove(ref(db, path));
      }
    };
    div.appendChild(delBtn);
  }

  return div;
}

// SEND MESSAGE
sendBtn.onclick = sendMessage;
inputMessage.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function sendMessage() {
  const text = inputMessage.value.trim();
  if (!text || !currentChannel) return;

  const filteredText = filterProfanity(text);
  const path = currentChannel.type === "server" ? `messages/servers/${currentChannel.id}` : `messages/dms/${currentChannel.id}`;
  const messagesRef = ref(db, path);

  push(messagesRef, {
    text: filteredText,
    userId: currentUser.uid,
    username: currentUser.email.split("@")[0],
    timestamp: Date.now()
  });

  inputMessage.value = "";
}

// SETUP UI
function setupUI() {
  inputArea.style.display = "flex";
}

// CREATE NEW SERVER
newServerBtn.onclick = () => {
  const name = prompt("Enter new server name:");
  if (!name) return;

  const serversRef = ref(db, "servers");
  push(serversRef, { name });
};

// LOGOUT HANDLER
onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    onUserLoggedIn();
  } else {
    currentUser = null;
    loginPanel.style.display = "block";
    mainUI.style.display = "none";
  }
});

function setupRealtimeListeners() {
  // No extra listeners for now, handled by onValue calls
}

</script>
</body>
</html>
